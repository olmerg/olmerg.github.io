<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de M√©tricas de Clasificaci√≥n - Triage</title>
    <!-- Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js para las gr√°ficas -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .metric-card {
            @apply bg-white p-4 rounded-lg shadow-md text-center transition-all duration-300;
        }
        .metric-title {
            @apply text-sm text-gray-500 font-medium;
        }
        .metric-value {
            @apply text-3xl font-bold text-indigo-600;
        }
        .confusion-matrix-cell {
            @apply p-4 rounded-lg text-white text-center flex flex-col justify-center items-center shadow-inner;
        }
        .cm-label {
            @apply text-xs uppercase font-semibold tracking-wider;
        }
        .cm-value {
            @apply text-4xl font-bold mt-1;
        }
        .cm-desc {
            @apply text-sm mt-2;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #4f46e5; cursor: pointer; border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; background: #4f46e5; cursor: pointer; border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Evaluaci√≥n de Clasificadores en Triage de Urgencias</h1>
            <p class="text-lg text-gray-600 mt-2">Un simulador interactivo para entender las m√©tricas de clasificaci√≥n.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Panel de Controles -->
            <aside class="w-full lg:w-1/3 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-3">Panel de Simulaci√≥n</h2>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Par√°metros de Poblaci√≥n</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="total-patients" class="text-sm font-medium text-gray-600 flex justify-between">Total de Pacientes: <span id="total-patients-value" class="font-bold text-indigo-600">200</span></label>
                                <input type="range" id="total-patients" min="50" max="1000" value="200" step="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="imbalance" class="text-sm font-medium text-gray-600 flex justify-between">Proporci√≥n de Cr√≠ticos (Clase Positiva): <span id="imbalance-value" class="font-bold text-indigo-600">10%</span></label>
                                <input type="range" id="imbalance" min="1" max="50" value="10" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Ajuste del Modelo Clasificador</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="threshold" class="text-sm font-medium text-gray-600 flex justify-between">Umbral de Decisi√≥n: <span id="threshold-value" class="font-bold text-indigo-600">40</span></label>
                                <input type="range" id="threshold" min="0" max="100" value="40" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <p class="text-xs text-gray-500 mt-1">Un umbral bajo es m√°s "sensible" (detecta m√°s cr√≠ticos), mientras que un umbral alto es m√°s "preciso" (se equivoca menos al decir que alguien es cr√≠tico).</p>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Costos de Clasificaci√≥n Err√≥nea</h3>
                        <div class="space-y-3">
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded">
                                <p class="font-bold">Falso Negativo (FN)</p>
                                <p class="text-sm">Un paciente cr√≠tico es clasificado como "No Cr√≠tico".<br><strong>Costo: ¬°EXTREMADAMENTE ALTO!</strong> Riesgo para la vida del paciente.</p>
                            </div>
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 rounded">
                                <p class="font-bold">Falso Positivo (FP)</p>
                                <p class="text-sm">Un paciente no cr√≠tico es clasificado como "Cr√≠tico".<br><strong>Costo:</strong> Medio. Uso innecesario de recursos de urgencias.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- √Årea Principal -->
            <main class="w-full lg:w-2/3">
                <!-- Matriz de Confusi√≥n -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Matriz de Confusi√≥n</h2>
                    <div class="grid grid-cols-[auto,1fr,1fr] gap-2 items-center">
                        <!-- Headers -->
                        <div></div>
                        <div class="text-center font-bold text-gray-600 p-2 border-b-2 border-gray-300">Predicci√≥n: Cr√≠tico</div>
                        <div class="text-center font-bold text-gray-600 p-2 border-b-2 border-gray-300">Predicci√≥n: No Cr√≠tico</div>
                        
                        <!-- Fila Realidad: Cr√≠tico -->
                        <div class="text-right font-bold text-gray-600 p-2">Realidad:<br>Cr√≠tico</div>
                        <!-- TP -->
                        <div class="confusion-matrix-cell bg-green-500">
                            <span class="cm-label">Verdadero Positivo (VP)</span>
                            <span id="tp-value" class="cm-value">0</span>
							</br>
                            <span class="cm-desc">Paciente cr√≠tico bien clasificado</span>
                        </div>
                        <!-- FN -->
                        <div class="confusion-matrix-cell bg-red-600">
                            <span class="cm-label">Falso Negativo (FN)</span>
                            <span id="fn-value" class="cm-value">0</span>
							</br>
                            <span class="cm-desc">¬°El error m√°s costoso!</span>
                        </div>
                        
                        <!-- Fila Realidad: No Cr√≠tico -->
                        <div class="text-right font-bold text-gray-600 p-2">Realidad:<br>No Cr√≠tico</div>
                         <!-- FP -->
                        <div class="confusion-matrix-cell bg-yellow-500">
                            <span class="cm-label">Falso Positivo (FP)</span>
                            <span id="fp-value" class="cm-value">0</span>
							</br>
                            <span class="cm-desc">Uso ineficiente de recursos</span>
                        </div>
                        <!-- TN -->
                        <div class="confusion-matrix-cell bg-blue-500">
                            <span class="cm-label">Verdadero Negativo (VN)</span>
                            <span id="tn-value" class="cm-value">0</span>
							</br>
                            <span class="cm-desc">Paciente no cr√≠tico bien clasificado</span>
                        </div>
                    </div>
                </div>

                <!-- M√©tricas -->
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">M√©tricas de Desempe√±o</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="metric-card">
                            <h4 class="metric-title">üéØ Exactitud (Accuracy)</h4>
                            <p id="accuracy-value" class="metric-value">0%</p>
                        </div>
                        <div class="metric-card">
                            <h4 class="metric-title">üîé Precisi√≥n (Precision)</h4>
                            <p id="precision-value" class="metric-value">0%</p>
                        </div>
                        <div class="metric-card">
                            <h4 class="metric-title">‚öïÔ∏è Sensibilidad (Recall)</h4>
                            <p id="recall-value" class="metric-value">0%</p>
                        </div>
                        <div class="metric-card">
                            <h4 class="metric-title">üõ°Ô∏è Especificidad (Specificity)</h4>
                            <p id="specificity-value" class="metric-value">0%</p>
                        </div>
                        <div class="metric-card col-span-2 md:col-span-1">
                            <h4 class="metric-title">‚öñÔ∏è Puntuaci√≥n F1 (F1-Score)</h4>
                            <p id="f1-score-value" class="metric-value">0.00</p>
                        </div>
                        <div id="accuracy-warning" class="hidden col-span-2 md:col-span-3 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded-md">
                            <p><strong class="font-bold">¬°Atenci√≥n!</strong> La exactitud parece alta, pero el modelo est√° fallando en detectar a los pacientes cr√≠ticos. En clases desbalanceadas, la exactitud puede ser una m√©trica enga√±osa.</p>
                        </div>
                    </div>
                </div>
                 <!-- Gr√°fica de distribuci√≥n -->
                <div id="plot" class="mt-8 bg-white p-4 rounded-xl shadow-lg min-h-[500px]"></div>
            </main>
        </div>
    </div>

<script>
    // --- ELEMENTOS DEL DOM ---
    const totalPatientsSlider = document.getElementById('total-patients');
    const imbalanceSlider = document.getElementById('imbalance');
    const thresholdSlider = document.getElementById('threshold');

    const totalPatientsValue = document.getElementById('total-patients-value');
    const imbalanceValue = document.getElementById('imbalance-value');
    const thresholdValue = document.getElementById('threshold-value');
    
    const tpValueEl = document.getElementById('tp-value');
    const fnValueEl = document.getElementById('fn-value');
    const fpValueEl = document.getElementById('fp-value');
    const tnValueEl = document.getElementById('tn-value');

    const accuracyValueEl = document.getElementById('accuracy-value');
    const precisionValueEl = document.getElementById('precision-value');
    const recallValueEl = document.getElementById('recall-value');
    const specificityValueEl = document.getElementById('specificity-value');
    const f1ScoreValueEl = document.getElementById('f1-score-value');
    const accuracyWarningEl = document.getElementById('accuracy-warning');
    const plotDiv = document.getElementById('plot');


    let patientsData = [];

    // --- L√ìGICA DE LA SIMULACI√ìN ---

    function generateData() {
        const totalPatients = parseInt(totalPatientsSlider.value);
        const criticalRatio = parseInt(imbalanceSlider.value) / 100;
        const numCritical = Math.floor(totalPatients * criticalRatio);
        const numNotCritical = totalPatients - numCritical;
        
        patientsData = [];

        // Generar pacientes NO cr√≠ticos
        for (let i = 0; i < numNotCritical; i++) {
            // Puntuaciones de gravedad m√°s bajas, con algo de ruido
            const gravityScore = Math.random() * 50;
            patientsData.push({ gravity: gravityScore, isCritical: 0 }); // 0 for Not Critical
        }
        
        // Generar pacientes CR√çTICOS
        for (let i = 0; i < numCritical; i++) {
            // Puntuaciones de gravedad m√°s altas, pero con solapamiento
            const gravityScore = 35 + Math.random() * 55;
            patientsData.push({ gravity: gravityScore, isCritical: 1 }); // 1 for Critical
        }
    }

    function runSimulation() {
        const threshold = parseInt(thresholdSlider.value);
        let tp = 0, fn = 0, fp = 0, tn = 0;

        patientsData.forEach(patient => {
            const predictionIsCritical = patient.gravity >= threshold;
            const realityIsCritical = patient.isCritical === 1;

            if (predictionIsCritical && realityIsCritical) {
                tp++;
            } else if (!predictionIsCritical && realityIsCritical) {
                fn++;
            } else if (predictionIsCritical && !realityIsCritical) {
                fp++;
            } else if (!predictionIsCritical && !realityIsCritical) {
                tn++;
            }
        });

        updateUI(tp, fn, fp, tn);
        drawPlot(threshold);
    }
    
    function updateUI(tp, fn, fp, tn) {
        const total = tp + fn + fp + tn;

        // Actualizar Matriz de Confusi√≥n
        tpValueEl.textContent = tp;
        fnValueEl.textContent = fn;
        fpValueEl.textContent = fp;
        tnValueEl.textContent = tn;

        // Calcular y actualizar M√©tricas
        const accuracy = total > 0 ? (tp + tn) / total : 0;
        const precision = (tp + fp) > 0 ? tp / (tp + fp) : 0;
        const recall = (tp + fn) > 0 ? tp / (tp + fn) : 0; // Sensibilidad
        const specificity = (tn + fp) > 0 ? tn / (tn + fp) : 0;
        const f1_score = (precision + recall) > 0 ? 2 * (precision * recall) / (precision + recall) : 0;

        accuracyValueEl.textContent = `${(accuracy * 100).toFixed(1)}%`;
        precisionValueEl.textContent = `${(precision * 100).toFixed(1)}%`;
        recallValueEl.textContent = `${(recall * 100).toFixed(1)}%`;
        specificityValueEl.textContent = `${(specificity * 100).toFixed(1)}%`;
        f1ScoreValueEl.textContent = f1_score.toFixed(2);
        
        // Mostrar advertencia de exactitud si es enga√±osa
        const isWarningNeeded = accuracy > 0.85 && recall < 0.5 && (tp+fn) > 0;
        accuracyWarningEl.classList.toggle('hidden', !isWarningNeeded);
    }

    function drawPlot(threshold) {
        const criticalPatients = patientsData.filter(p => p.isCritical === 1);
        const notCriticalPatients = patientsData.filter(p => p.isCritical === 0);

        const traceCritical = {
            x: criticalPatients.map(p => p.gravity),
            type: 'histogram',
            name: 'Cr√≠tico (Real)',
            marker: { color: 'rgba(239, 68, 68, 0.7)' },
            xbins: { size: 2.5 }
        };

        const traceNotCritical = {
            x: notCriticalPatients.map(p => p.gravity),
            type: 'histogram',
            name: 'No Cr√≠tico (Real)',
            marker: { color: 'rgba(59, 130, 246, 0.7)' },
            xbins: { size: 2.5 }
        };

        const layout = {
            title: 'Distribuci√≥n de Pacientes por √çndice de Gravedad',
            xaxis: { title: '√çndice de Gravedad Simulado' },
            yaxis: { title: 'Cantidad de Pacientes' },
            barmode: 'overlay',
            shapes: [{
                type: 'line',
                x0: threshold,
                x1: threshold,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: {
                    color: '#4f46e5',
                    width: 3,
                    dash: 'dash'
                }
            }],
             annotations: [{
                x: threshold,
                y: 1,
                yref: 'paper',
                text: 'Umbral',
                showarrow: true,
                arrowhead: 7,
                ax: 0,
                ay: -40,
                font: {
                    color: '#4f46e5',
                    weight: 'bold'
                }
            }],
            legend: { x: 0.6, y: 0.95 }
        };

        Plotly.newPlot(plotDiv, [traceNotCritical, traceCritical], layout, {responsive: true});
    }

    // --- MANEJADORES DE EVENTOS ---
    function handleControlsChange() {
        // Actualizar etiquetas
        totalPatientsValue.textContent = totalPatientsSlider.value;
        imbalanceValue.textContent = `${imbalanceSlider.value}%`;
        thresholdValue.textContent = thresholdSlider.value;
        
        runSimulation();
    }
    
    function handleDataChange() {
        totalPatientsValue.textContent = totalPatientsSlider.value;
        imbalanceValue.textContent = `${imbalanceSlider.value}%`;
        
        generateData();
        runSimulation();
    }

    // Asignar eventos
    totalPatientsSlider.addEventListener('input', handleDataChange);
    imbalanceSlider.addEventListener('input', handleDataChange);
    thresholdSlider.addEventListener('input', handleControlsChange);
    
    // --- INICIALIZACI√ìN ---
    window.addEventListener('load', () => {
        generateData();
        handleControlsChange();
    });
</script>

</body>
</html>

